name: Deploy to ragtest

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        
      - name: Debug - list files
        run: |
          pwd
          ls -la
      - name: Tar project
        run: tar czf bundle.tgz Dockerfile requirements.txt main.py .dockerignore .github/workflows/deploy.yml
        
      - name: Upload tarball
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.DEPLOY_KEY }}
          source: "bundle.tgz"
          target: "/opt/ragtest"
          rm: false
          debug: true
      
      - name: Unpack & build on server
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            set -e
            cd /opt/ragtest
            tar xzf bundle.tgz
            # 이하 동일
            if ! command -v docker >/dev/null 2>&1; then
              apt-get update && apt-get install -y docker.io
              systemctl enable --now docker
            fi
            mkdir -p /root/ragtest-data /root/hf-cache
            docker build --pull -t ragtest:latest .
            docker rm -f ragtest || true
            docker run -d --name ragtest -p 5000:5000 \
              -v /root/ragtest-data:/data \
              -v /root/hf-cache:/root/.cache \
              --restart unless-stopped ragtest:latest
            sleep 2
            docker ps --filter "name=ragtest"

